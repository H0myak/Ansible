vcl 4.0;
import directors;

probe backend_healthcheck {
    .url = "/";
    .timeout = 1s;
    .interval = 1s;
    .window = 3;
    .threshold = 1;
}

backend nginx {
    .host = "127.0.0.1";
    .port = "82";
    .probe = backend_healthcheck;
}

backend backup1 {
    .host = "127.0.0.1";
    .port = "83";
    .probe = backend_healthcheck;
}

sub vcl_init {
    new test = directors.round_robin();
    test.add_backend(nginx);
    test.add_backend(backup1);
}

sub vcl_recv {

    if (req.http.host ~ "example.com") {
        if (req.http.cookie ~ "^\s*$") {
           unset req.http.cookie;
           }
    unset req.http.X-Forwarded-For;
    set req.http.X-Forwarded-For = client.ip;
    set req.backend_hint = test.backend();
    }
}

sub vcl_backend_response {
    if (bereq.url ~ "(7z|avi|bz2|flac|flv|gz|mka|mkv|mov|mp3|mp4|mpeg|png|mpg|ogg|ogm|opus|rar|tar|tgz|tbz|txz|wav|webm|xz|zip)") {
        unset beresp.http.cookie;
        set beresp.http.cache-control = "static, max-age=600";
        set beresp.storage_hint = "static";
        set beresp.http.x-storage = "static";
        set beresp.ttl = 5m;
    if (req.http.Cache-Control ~ "(?i)no-cache") {
        set beresp.uncacheable = true;
        }
    set beresp.uncacheable = true;
}

sub vcl_deliver {
    unset resp.http.Via;
    unset resp.http.X-Whatever;
    unset resp.http.X-Varnish;
    unset resp.http.Age;
}

sub vcl_backend_error {

    if(beresp.status == 503) {
        set beresp.status = 666;
        synthetic({"Something going wrong..."});
    }
    return (deliver);
}
